<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¿«é€’æŸ¥è¯¢ç³»ç»Ÿ - Supabaseç‰ˆ</title>
    
    <!-- âš ï¸ é‡è¦ï¼šSupabaseåº“åªåœ¨è¿™é‡Œå¼•å…¥ä¸€æ¬¡ -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 1200px;
            overflow: hidden;
        }

        /* ç™»å½•ç•Œé¢æ ·å¼ */
        #unifiedLoginContainer {
            padding: 60px 40px;
            text-align: center;
        }

        .login-title {
            font-size: 32px;
            color: #333;
            margin-bottom: 40px;
            font-weight: 600;
        }

        .login-tabs {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 40px;
        }

        .tab-btn {
            padding: 12px 40px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            font-weight: 500;
        }

        .tab-btn.active {
            background: #667eea;
            color: white;
        }

        .tab-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .login-form {
            display: none;
            max-width: 400px;
            margin: 0 auto;
        }

        .login-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 25px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 14px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .login-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        /* ç”¨æˆ·ç•Œé¢æ ·å¼ */
        #userInterface, #adminInterface {
            display: none;
            padding: 30px;
        }

        #userInterface.active, #adminInterface.active {
            display: block;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .header h1 {
            color: #333;
            font-size: 28px;
        }

        .logout-btn {
            padding: 10px 25px;
            background: #ff4757;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: #ff3838;
            transform: translateY(-2px);
        }

        /* ç”¨æˆ·ä¿¡æ¯é¢æ¿ */
        .user-panel {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .user-info-item {
            text-align: center;
        }

        .user-info-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .user-info-value {
            font-size: 24px;
            font-weight: 600;
        }

        /* æŸ¥è¯¢è¡¨æ ¼ */
        .query-section {
            margin-top: 30px;
        }

        .section-title {
            font-size: 20px;
            color: #333;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .query-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .query-table th {
            background: #f8f9fa;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #555;
            border-bottom: 2px solid #e0e0e0;
        }

        .query-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        .query-table input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }

        .query-table input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn-query {
            padding: 8px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            margin-right: 5px;
        }

        .btn-query:hover {
            background: #5568d3;
        }

        .btn-add {
            padding: 10px 25px;
            background: #2ecc71;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }

        .btn-add:hover {
            background: #27ae60;
        }

        /* çŠ¶æ€æ ‡ç­¾ */
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-querying {
            background: #cce5ff;
            color: #004085;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
        }

        .status-failed {
            background: #f8d7da;
            color: #721c24;
        }

        /* ä¼šå‘˜ç­‰çº§æ ‡ç­¾ */
        .level-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .level-trial {
            background: #e3f2fd;
            color: #1976d2;
        }

        .level-gold {
            background: #fff8e1;
            color: #f57f17;
        }

        .level-platinum {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        /* ç‰©æµè¯¦æƒ… */
        .logistics-details {
            margin-top: 10px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 13px;
        }

        .logistics-item {
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .logistics-item:last-child {
            border-bottom: none;
        }

        .logistics-time {
            color: #667eea;
            font-weight: 500;
            margin-right: 10px;
        }

        /* ç®¡ç†å‘˜è¡¨æ ¼ */
        .admin-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-top: 20px;
        }

        .admin-table th {
            background: #667eea;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .admin-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        .btn-table {
            padding: 6px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            margin-right: 5px;
            transition: all 0.3s;
        }

        .btn-edit {
            background: #3498db;
            color: white;
        }

        .btn-edit:hover {
            background: #2980b9;
        }

        .btn-disable {
            background: #e74c3c;
            color: white;
        }

        .btn-disable:hover {
            background: #c0392b;
        }

        /* æç¤ºä¿¡æ¯ */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: #333;
            color: white;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 9999;
            animation: slideIn 0.3s ease;
        }

        .toast.success {
            background: #2ecc71;
        }

        .toast.error {
            background: #e74c3c;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .container {
                margin: 10px;
            }

            #unifiedLoginContainer {
                padding: 40px 20px;
            }

            .login-title {
                font-size: 24px;
            }

            .user-panel {
                grid-template-columns: 1fr;
            }

            .query-table, .admin-table {
                font-size: 12px;
            }

            .query-table th, .query-table td,
            .admin-table th, .admin-table td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ç»Ÿä¸€ç™»å½•ç•Œé¢ -->
        <div id="unifiedLoginContainer">
            <h1 class="login-title">ğŸ“¦ å¿«é€’æŸ¥è¯¢ç³»ç»Ÿ</h1>
            
            <div class="login-tabs">
                <button class="tab-btn active" onclick="switchLoginTab('user')">ç”¨æˆ·ç™»å½•</button>
                <button class="tab-btn" onclick="switchLoginTab('admin')">ç®¡ç†å‘˜ç™»å½•</button>
            </div>

            <!-- ç”¨æˆ·ç™»å½•è¡¨å• -->
            <div id="userLoginForm" class="login-form active">
                <div class="form-group">
                    <label for="loginUserPhone">æ‰‹æœºå·</label>
                    <input type="tel" id="loginUserPhone" placeholder="è¯·è¾“å…¥æ‰‹æœºå·" maxlength="11">
                </div>
                <button class="login-btn" onclick="handleUserLogin()">ç™»å½• / æ³¨å†Œ</button>
                <p style="margin-top: 15px; color: #999; font-size: 14px;">
                    æ–°ç”¨æˆ·é¦–æ¬¡ç™»å½•è‡ªåŠ¨æ³¨å†Œï¼Œèµ é€1æ¬¡è¯•ç”¨é¢åº¦
                </p>
            </div>

            <!-- ç®¡ç†å‘˜ç™»å½•è¡¨å• -->
            <div id="adminLoginForm" class="login-form">
                <div class="form-group">
                    <label for="adminUsername">ç®¡ç†å‘˜è´¦å·</label>
                    <input type="text" id="adminUsername" placeholder="è¯·è¾“å…¥ç®¡ç†å‘˜è´¦å·">
                </div>
                <div class="form-group">
                    <label for="adminPassword">å¯†ç </label>
                    <input type="password" id="adminPassword" placeholder="è¯·è¾“å…¥å¯†ç ">
                </div>
                <button class="login-btn" onclick="handleAdminLogin()">ç™»å½•</button>
                <p style="margin-top: 15px; color: #999; font-size: 14px;">
                    é»˜è®¤è´¦å·ï¼šadmin / å¯†ç ï¼šadmin123
                </p>
            </div>
        </div>

        <!-- ç”¨æˆ·ç•Œé¢ -->
        <div id="userInterface">
            <div class="header">
                <h1>ç”¨æˆ·ä¸­å¿ƒ</h1>
                <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
            </div>

            <!-- ç”¨æˆ·ä¿¡æ¯é¢æ¿ -->
            <div class="user-panel">
                <div class="user-info-item">
                    <div class="user-info-label">æ‰‹æœºå·</div>
                    <div class="user-info-value" id="userPhone">-</div>
                </div>
                <div class="user-info-item">
                    <div class="user-info-label">ç”¨æˆ·å</div>
                    <div class="user-info-value" id="userName">-</div>
                </div>
                <div class="user-info-item">
                    <div class="user-info-label">ä¼šå‘˜ç­‰çº§</div>
                    <div class="user-info-value" id="userLevel">-</div>
                </div>
                <div class="user-info-item">
                    <div class="user-info-label">æ€»é¢åº¦</div>
                    <div class="user-info-value" id="totalQuota">0</div>
                </div>
                <div class="user-info-item">
                    <div class="user-info-label">å·²ä½¿ç”¨</div>
                    <div class="user-info-value" id="usedQuota">0</div>
                </div>
                <div class="user-info-item">
                    <div class="user-info-label">å‰©ä½™é¢åº¦</div>
                    <div class="user-info-value" id="remainQuota">0</div>
                </div>
            </div>

            <!-- å¿«é€’æŸ¥è¯¢åŒºåŸŸ -->
            <div class="query-section">
                <h2 class="section-title">å¿«é€’æŸ¥è¯¢</h2>
                <button class="btn-add" onclick="addQueryRow()">+ æ·»åŠ æŸ¥è¯¢</button>
                
                <table class="query-table">
                    <thead>
                        <tr>
                            <th style="width: 30%">å¿«é€’å•å·</th>
                            <th style="width: 20%">æ‰‹æœºå·å4ä½ï¼ˆé€‰å¡«ï¼‰</th>
                            <th style="width: 15%">çŠ¶æ€</th>
                            <th style="width: 20%">å¿«é€’å…¬å¸</th>
                            <th style="width: 15%">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="queryTableBody">
                        <!-- åŠ¨æ€æ·»åŠ è¡Œ -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ç®¡ç†å‘˜ç•Œé¢ -->
        <div id="adminInterface">
            <div class="header">
                <h1>ç®¡ç†å‘˜åå°</h1>
                <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
            </div>

            <div class="query-section">
                <h2 class="section-title">ç”¨æˆ·ç®¡ç†</h2>
                
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>æ‰‹æœºå·</th>
                            <th>ç”¨æˆ·å</th>
                            <th>ä¼šå‘˜ç­‰çº§</th>
                            <th>æ€»é¢åº¦</th>
                            <th>å·²ä½¿ç”¨</th>
                            <th>å‰©ä½™é¢åº¦</th>
                            <th>æ³¨å†Œæ—¶é—´</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="adminUsersTableBody">
                        <!-- åŠ¨æ€æ·»åŠ ç”¨æˆ·æ•°æ® -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- âš ï¸ é‡è¦ï¼šæ‰€æœ‰JavaScriptä»£ç åªåœ¨è¿™é‡Œå†™ä¸€æ¬¡ -->
    <script>
        // ========================================
        // Supabase é…ç½®ï¼ˆâš ï¸ è¯·æ›¿æ¢ä¸ºä½ çš„å®é™…é…ç½®ï¼‰
        // ========================================
        const SUPABASE_URL = 'https://pukyydqtctlvexbndvep.supabase.co'
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB1a3l5ZHF0Y3RsdmV4Ym5kdmVwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4MzQ0MjIsImV4cCI6MjA4MjQxMDQyMn0.1u5yf_3RJWgoJxxMg-CsYZViraJjreMXRH3XBslJaco'

        // âš ï¸ é‡è¦ï¼šsupabaseå˜é‡åªåœ¨è¿™é‡Œå£°æ˜ä¸€æ¬¡
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY)

        // ========================================
        // å…¨å±€å˜é‡
        // ========================================
        let currentUser = null
        let authToken = localStorage.getItem('authToken')
        let queryRowCounter = 0

        // ========================================
        // å·¥å…·å‡½æ•°ï¼šæ˜¾ç¤ºæç¤ºä¿¡æ¯
        // ========================================
        function showToast(message, type = 'success') {
            const toast = document.createElement('div')
            toast.className = `toast ${type}`
            toast.textContent = message
            document.body.appendChild(toast)

            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease reverse'
                setTimeout(() => {
                    document.body.removeChild(toast)
                }, 300)
            }, 3000)
        }

        // ========================================
        // ç™»å½•ç•Œé¢ï¼šåˆ‡æ¢æ ‡ç­¾é¡µ
        // ========================================
        function switchLoginTab(type) {
            const userTab = document.querySelector('.tab-btn:first-child')
            const adminTab = document.querySelector('.tab-btn:last-child')
            const userForm = document.getElementById('userLoginForm')
            const adminForm = document.getElementById('adminLoginForm')

            if (type === 'user') {
                userTab.classList.add('active')
                adminTab.classList.remove('active')
                userForm.classList.add('active')
                adminForm.classList.remove('active')
            } else {
                adminTab.classList.add('active')
                userTab.classList.remove('active')
                adminForm.classList.add('active')
                userForm.classList.remove('active')
            }
        }

        // ========================================
        // ç”¨æˆ·ç™»å½•/æ³¨å†Œ
        // ========================================
        async function handleUserLogin() {
            const phone = document.getElementById('loginUserPhone').value.trim()
            
            if (!phone || !/^1[3-9]\d{9}$/.test(phone)) {
                showToast('è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·', 'error')
                return
            }
            
            try {
                const { data: existUser, error: queryError } = await supabase
                    .from('users')
                    .select('*')
                    .eq('phone', phone)
                    .single()
                
                if (queryError && queryError.code !== 'PGRST116') {
                    throw queryError
                }
                
                if (!existUser) {
                    const { data: newUser, error: insertError } = await supabase
                        .from('users')
                        .insert([{
                            phone: phone,
                            user_name: 'æ–°ç”¨æˆ·',
                            avatar: 'color-1',
                            level: 'trial',
                            total_quota: 1,
                            used_quota: 0,
                            disabled: false
                        }])
                        .select()
                        .single()
                    
                    if (insertError) throw insertError
                    
                    currentUser = newUser
                    showToast('æ³¨å†ŒæˆåŠŸï¼èµ é€1æ¬¡è¯•ç”¨é¢åº¦', 'success')
                } else {
                    if (existUser.disabled) {
                        showToast('è´¦æˆ·å·²è¢«åœç”¨ï¼Œè¯·è”ç³»ç®¡ç†å‘˜', 'error')
                        return
                    }
                    currentUser = existUser
                    showToast('ç™»å½•æˆåŠŸï¼', 'success')
                }
                
                authToken = currentUser.id.toString()
                localStorage.setItem('authToken', authToken)
                
                document.getElementById('unifiedLoginContainer').style.display = 'none'
                document.getElementById('userInterface').classList.add('active')
                
                updateUserPanel()
                addQueryRow()
                
            } catch (error) {
                console.error('ç™»å½•å¤±è´¥:', error)
                showToast('ç™»å½•å¤±è´¥ï¼š' + error.message, 'error')
            }
        }

        // ========================================
        // ç®¡ç†å‘˜ç™»å½•
        // ========================================
        async function handleAdminLogin() {
            const username = document.getElementById('adminUsername').value.trim()
            const password = document.getElementById('adminPassword').value.trim()
            
            if (!username || !password) {
                showToast('è¯·è¾“å…¥è´¦å·å’Œå¯†ç ', 'error')
                return
            }
            
            if (username === 'admin' && password === 'admin123') {
                authToken = 'admin'
                localStorage.setItem('authToken', authToken)
                
                document.getElementById('unifiedLoginContainer').style.display = 'none'
                document.getElementById('adminInterface').classList.add('active')
                
                loadAdminData()
                showToast('ç™»å½•æˆåŠŸï¼', 'success')
            } else {
                showToast('è´¦å·æˆ–å¯†ç é”™è¯¯', 'error')
            }
        }

        // ========================================
        // é€€å‡ºç™»å½•
        // ========================================
        function logout() {
            localStorage.removeItem('authToken')
            authToken = null
            currentUser = null
            
            document.getElementById('userInterface').classList.remove('active')
            document.getElementById('adminInterface').classList.remove('active')
            document.getElementById('unifiedLoginContainer').style.display = 'block'
            
            document.getElementById('loginUserPhone').value = ''
            document.getElementById('adminUsername').value = ''
            document.getElementById('adminPassword').value = ''
            document.getElementById('queryTableBody').innerHTML = ''
            queryRowCounter = 0
            
            showToast('å·²é€€å‡ºç™»å½•', 'success')
        }

        // ========================================
        // æ›´æ–°ç”¨æˆ·ä¿¡æ¯é¢æ¿
        // ========================================
        function updateUserPanel() {
            if (!currentUser) return
            
            document.getElementById('userPhone').textContent = currentUser.phone
            document.getElementById('userName').textContent = currentUser.user_name || 'æ–°ç”¨æˆ·'
            document.getElementById('userLevel').textContent = getLevelText(currentUser.level)
            document.getElementById('totalQuota').textContent = currentUser.total_quota
            document.getElementById('usedQuota').textContent = currentUser.used_quota
            document.getElementById('remainQuota').textContent = currentUser.total_quota - currentUser.used_quota
        }

        // ========================================
        // åˆ·æ–°ç”¨æˆ·ä¿¡æ¯
        // ========================================
        async function refreshUserInfo() {
            if (!authToken || authToken === 'admin') return
            
            try {
                const { data: user, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('id', parseInt(authToken))
                    .single()
                
                if (error) throw error
                
                currentUser = user
                updateUserPanel()
            } catch (error) {
                console.error('åˆ·æ–°å¤±è´¥:', error)
            }
        }

        // ========================================
        // è·å–ä¼šå‘˜ç­‰çº§æ–‡æœ¬
        // ========================================
        function getLevelText(level) {
            const levels = {
                'trial': 'è¯•ç”¨ä¼šå‘˜',
                'gold': 'é»„é‡‘ä¼šå‘˜',
                'platinum': 'é“‚é‡‘ä¼šå‘˜'
            }
            return levels[level] || level
        }

        // ========================================
        // æ·»åŠ æŸ¥è¯¢è¡Œ
        // ========================================
        function addQueryRow() {
            queryRowCounter++
            const id = queryRowCounter
            
            const tbody = document.getElementById('queryTableBody')
            const row = document.createElement('tr')
            row.id = `row-${id}`
            row.innerHTML = `
                <td>
                    <input type="text" id="number-${id}" placeholder="è¯·è¾“å…¥å¿«é€’å•å·">
                </td>
                <td>
                    <input type="text" id="mobile-${id}" placeholder="é€‰å¡«" maxlength="4">
                </td>
                <td>
                    <span class="status-badge status-pending" id="status-${id}">å¾…æŸ¥è¯¢</span>
                </td>
                <td id="company-${id}">-</td>
                <td>
                    <button class="btn-query" onclick="querySingle(${id})">æŸ¥è¯¢</button>
                    <button class="btn-query" style="background: #e74c3c;" onclick="deleteRow(${id})">åˆ é™¤</button>
                </td>
            `
            tbody.appendChild(row)
            
            const detailRow = document.createElement('tr')
            detailRow.id = `detail-${id}`
            detailRow.style.display = 'none'
            detailRow.innerHTML = `
                <td colspan="5">
                    <div class="logistics-details" id="logistics-${id}"></div>
                </td>
            `
            tbody.appendChild(detailRow)
        }

        // ========================================
        // åˆ é™¤æŸ¥è¯¢è¡Œ
        // ========================================
        function deleteRow(id) {
            const row = document.getElementById(`row-${id}`)
            const detailRow = document.getElementById(`detail-${id}`)
            
            if (row) row.remove()
            if (detailRow) detailRow.remove()
        }

        // ========================================
        // å•ä¸ªæŸ¥è¯¢
        // ========================================
        async function querySingle(id) {
            const number = document.getElementById(`number-${id}`).value.trim()
            const mobile = document.getElementById(`mobile-${id}`).value.trim()
            
            if (!number) {
                showToast('è¯·è¾“å…¥å¿«é€’å•å·', 'error')
                return
            }
            
            if (!authToken || authToken === 'admin') {
                showToast('è¯·å…ˆç™»å½•', 'error')
                return
            }
            
            updateRowStatus(id, 'querying')
            
            try {
                const { data: user, error: userError } = await supabase
                    .from('users')
                    .select('*')
                    .eq('id', parseInt(authToken))
                    .single()
                
                if (userError) throw userError
                
                if (user.used_quota >= user.total_quota) {
                    updateRowStatus(id, 'failed')
                    showToast('æŸ¥è¯¢é¢åº¦ä¸è¶³ï¼Œè¯·è”ç³»ç®¡ç†å‘˜å……å€¼', 'error')
                    return
                }
                
                const { data: config, error: configError } = await supabase
                    .from('system_config')
                    .select('config_value')
                    .eq('config_key', 'API_APPCODE')
                    .single()
                
                if (configError) {
                    throw new Error('APIæœªé…ç½®ï¼Œè¯·è”ç³»ç®¡ç†å‘˜')
                }
                
                const formData = new URLSearchParams()
                formData.append('number', number)
                if (mobile) formData.append('mobile', mobile)
                
                const response = await fetch('https://jmexpresv2.market.alicloudapi.com/express/query-v2', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'APPCODE ' + config.config_value,
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: formData
                })
                
                const result = await response.json()
                
                if (result.code === 200 && result.data) {
                    updateRowData(id, result.data)
                    updateRowStatus(id, 'success')
                    
                    await supabase
                        .from('users')
                        .update({ used_quota: user.used_quota + 1 })
                        .eq('id', parseInt(authToken))
                    
                    await supabase
                        .from('query_logs')
                        .insert([{
                            user_id: parseInt(authToken),
                            express_number: number,
                            mobile: mobile,
                            company_name: result.data.expressCompanyName || 'æœªçŸ¥',
                            status: 'success'
                        }])
                    
                    await refreshUserInfo()
                    showToast('æŸ¥è¯¢æˆåŠŸï¼', 'success')
                } else {
                    updateRowStatus(id, 'failed')
                    showToast(result.msg || 'æŸ¥è¯¢å¤±è´¥ï¼Œè¯·æ£€æŸ¥å•å·æ˜¯å¦æ­£ç¡®', 'error')
                }
                
            } catch (error) {
                console.error('æŸ¥è¯¢å¤±è´¥:', error)
                updateRowStatus(id, 'failed')
                showToast('æŸ¥è¯¢å¤±è´¥ï¼š' + error.message, 'error')
            }
        }

        // ========================================
        // æ›´æ–°è¡ŒçŠ¶æ€
        // ========================================
        function updateRowStatus(id, status) {
            const statusElement = document.getElementById(`status-${id}`)
            if (!statusElement) return
            
            const statusMap = {
                'pending': { text: 'å¾…æŸ¥è¯¢', class: 'status-pending' },
                'querying': { text: 'æŸ¥è¯¢ä¸­...', class: 'status-querying' },
                'success': { text: 'æŸ¥è¯¢æˆåŠŸ', class: 'status-success' },
                'failed': { text: 'æŸ¥è¯¢å¤±è´¥', class: 'status-failed' }
            }
            
            const statusInfo = statusMap[status]
            if (statusInfo) {
                statusElement.textContent = statusInfo.text
                statusElement.className = 'status-badge ' + statusInfo.class
            }
        }

        // ========================================
        // æ›´æ–°è¡Œæ•°æ®ï¼ˆæ˜¾ç¤ºç‰©æµä¿¡æ¯ï¼‰
        // ========================================
        function updateRowData(id, data) {
            const companyElement = document.getElementById(`company-${id}`)
            if (companyElement) {
                companyElement.textContent = data.expressCompanyName || 'æœªçŸ¥'
            }
            
            const detailRow = document.getElementById(`detail-${id}`)
            const logisticsElement = document.getElementById(`logistics-${id}`)
            
            if (detailRow && logisticsElement && data.list && data.list.length > 0) {
                detailRow.style.display = 'table-row'
                
                let html = '<div style="margin-bottom: 10px; font-weight: 600; color: #333;">'
                html += `ğŸ“¦ ${data.expressCompanyName || 'æœªçŸ¥å¿«é€’'} - ${data.number || ''}`
                html += '</div>'
                
                const list = data.list.slice(0, 10)
                list.forEach((item, index) => {
                    html += `
                        <div class="logistics-item">
                            <span class="logistics-time">${item.time || ''}</span>
                            <span>${item.status || ''}</span>
                        </div>
                    `
                })
                
                if (data.list.length > 10) {
                    html += `<div style="text-align: center; color: #999; margin-top: 10px;">ä»…æ˜¾ç¤ºæœ€æ–°10æ¡è®°å½•</div>`
                }
                
                logisticsElement.innerHTML = html
            }
        }

        // ========================================
        // ç®¡ç†å‘˜ï¼šåŠ è½½æ‰€æœ‰ç”¨æˆ·
        // ========================================
        async function loadAdminData() {
            try {
                const { data: users, error } = await supabase
                    .from('users')
                    .select('*')
                    .order('created_at', { ascending: false })
                
                if (error) throw error
                
                const tbody = document.getElementById('adminUsersTableBody')
                tbody.innerHTML = ''
                
                if (users.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 40px; color: #999;">
                                æš‚æ— ç”¨æˆ·æ•°æ®
                            </td>
                        </tr>
                    `
                    return
                }
                
                users.forEach(user => {
                    const row = document.createElement('tr')
                    row.innerHTML = `
                        <td>${user.phone}</td>
                        <td>${user.user_name || 'æœªè®¾ç½®'}</td>
                        <td>
                            <span class="level-badge level-${user.level}">
                                ${getLevelText(user.level)}
                            </span>
                        </td>
                        <td>${user.total_quota}</td>
                        <td>${user.used_quota}</td>
                        <td>${user.total_quota - user.used_quota}</td>
                        <td>${formatDate(user.created_at)}</td>
                        <td>
                            <button class="btn-table btn-edit" onclick="editUserQuota(${user.id}, ${user.total_quota})">
                                ä¿®æ”¹é¢åº¦
                            </button>
                            <button class="btn-table ${user.disabled ? 'btn-edit' : 'btn-disable'}" 
                                    onclick="toggleUserStatus(${user.id}, ${user.disabled})">
                                ${user.disabled ? 'å¯ç”¨' : 'åœç”¨'}
                            </button>
                        </td>
                    `
                    tbody.appendChild(row)
                })
                
                showToast(`åŠ è½½æˆåŠŸï¼Œå…± ${users.length} ä¸ªç”¨æˆ·`, 'success')
                
            } catch (error) {
                console.error('åŠ è½½å¤±è´¥:', error)
                showToast('åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥ï¼š' + error.message, 'error')
            }
        }

        // ========================================
        // ç®¡ç†å‘˜ï¼šä¿®æ”¹ç”¨æˆ·é¢åº¦
        // ========================================
        async function editUserQuota(userId, currentQuota) {
            const newQuota = prompt('è¯·è¾“å…¥æ–°çš„æ€»é¢åº¦:', currentQuota)
            
            if (newQuota === null) return
            
            if (!/^\d+$/.test(newQuota)) {
                showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—', 'error')
                return
            }
            
            try {
                const { error } = await supabase
                    .from('users')
                    .update({ total_quota: parseInt(newQuota) })
                    .eq('id', userId)
                
                if (error) throw error
                
                showToast('ä¿®æ”¹æˆåŠŸï¼', 'success')
                loadAdminData()
            } catch (error) {
                console.error('ä¿®æ”¹å¤±è´¥:', error)
                showToast('ä¿®æ”¹å¤±è´¥ï¼š' + error.message, 'error')
            }
        }

        // ========================================
        // ç®¡ç†å‘˜ï¼šåœç”¨/å¯ç”¨ç”¨æˆ·
        // ========================================
        async function toggleUserStatus(userId, currentStatus) {
            const action = currentStatus ? 'å¯ç”¨' : 'åœç”¨'
            
            if (!confirm(`ç¡®å®šè¦${action}è¯¥ç”¨æˆ·å—ï¼Ÿ`)) {
                return
            }
            
            try {
                const { error } = await supabase
                    .from('users')
                    .update({ disabled: !currentStatus })
                    .eq('id', userId)
                
                if (error) throw error
                
                showToast(`å·²${action}ç”¨æˆ·`, 'success')
                loadAdminData()
            } catch (error) {
                console.error('æ“ä½œå¤±è´¥:', error)
                showToast('æ“ä½œå¤±è´¥ï¼š' + error.message, 'error')
            }
        }

        // ========================================
        // å·¥å…·å‡½æ•°ï¼šæ ¼å¼åŒ–æ—¥æœŸ
        // ========================================
        function formatDate(dateString) {
            if (!dateString) return '-'
            
            const date = new Date(dateString)
            const year = date.getFullYear()
            const month = String(date.getMonth() + 1).padStart(2, '0')
            const day = String(date.getDate()).padStart(2, '0')
            const hours = String(date.getHours()).padStart(2, '0')
            const minutes = String(date.getMinutes()).padStart(2, '0')
            
            return `${year}-${month}-${day} ${hours}:${minutes}`
        }

        // ========================================
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
        // ========================================
        window.addEventListener('DOMContentLoaded', async () => {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œæ£€æŸ¥ç™»å½•çŠ¶æ€...')
            
            if (authToken && authToken !== 'admin') {
                try {
                    const { data: user, error } = await supabase
                        .from('users')
                        .select('*')
                        .eq('id', parseInt(authToken))
                        .single()
                    
                    if (!error && user && !user.disabled) {
                        currentUser = user
                        document.getElementById('unifiedLoginContainer').style.display = 'none'
                        document.getElementById('userInterface').classList.add('active')
                        updateUserPanel()
                        addQueryRow()
                        console.log('ç”¨æˆ·è‡ªåŠ¨ç™»å½•æˆåŠŸ')
                    } else {
                        localStorage.removeItem('authToken')
                        authToken = null
                    }
                } catch (error) {
                    console.error('è‡ªåŠ¨ç™»å½•å¤±è´¥:', error)
                    localStorage.removeItem('authToken')
                    authToken = null
                }
            } else if (authToken === 'admin') {
                document.getElementById('unifiedLoginContainer').style.display = 'none'
                document.getElementById('adminInterface').classList.add('active')
                loadAdminData()
                console.log('ç®¡ç†å‘˜è‡ªåŠ¨ç™»å½•æˆåŠŸ')
            }
        })

        console.log('å¿«é€’æŸ¥è¯¢ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼')
        console.log('Supabase URL:', SUPABASE_URL)
    </script>
</body>
</html>
